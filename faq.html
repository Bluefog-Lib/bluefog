

<!DOCTYPE html>
<html class="writer-html5" lang="en" >
<head>
  <meta charset="utf-8" />
  
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  
  <title>FAQ &mdash; Bluefog  documentation</title>
  

  
  <link rel="stylesheet" href="_static/css/theme.css" type="text/css" />
  <link rel="stylesheet" href="_static/pygments.css" type="text/css" />

  
  
    <link rel="shortcut icon" href="_static/favicon.png"/>
  

  
  

  

  
  <!--[if lt IE 9]>
    <script src="_static/js/html5shiv.min.js"></script>
  <![endif]-->
  
    
      <script type="text/javascript" id="documentation_options" data-url_root="./" src="_static/documentation_options.js"></script>
        <script src="_static/jquery.js"></script>
        <script src="_static/underscore.js"></script>
        <script src="_static/doctools.js"></script>
    
    <script type="text/javascript" src="_static/js/theme.js"></script>

    
    <link rel="index" title="Index" href="genindex.html" />
    <link rel="search" title="Search" href="search.html" />
    <link rel="prev" title="BlueFog Development Guide" href="devel_guide.html" /> 
</head>

<body class="wy-body-for-nav">

   
  <div class="wy-grid-for-nav">
    
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >
          

          
            <a href="index.html" class="icon icon-home"> Bluefog
          

          
          </a>

          
            
            
              <div class="version">
                0.2.2
              </div>
            
          

          
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>

          
        </div>

        
        <div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="main navigation">
          
            
            
              
            
            
              <p class="caption"><span class="caption-text">INSTALLATION</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="install.html">Installing Bluefog</a></li>
</ul>
<p class="caption"><span class="caption-text">API</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="torch_api.html">Bluefog Torch API</a></li>
<li class="toctree-l1"><a class="reference internal" href="topo_api.html">Bluefog Topology API</a></li>
</ul>
<p class="caption"><span class="caption-text">More Information</span></p>
<ul class="current">
<li class="toctree-l1"><a class="reference internal" href="bluefog_ops.html">Bluefog Ops Explanation</a></li>
<li class="toctree-l1"><a class="reference internal" href="performance.html">Bluefog Performance</a></li>
<li class="toctree-l1"><a class="reference internal" href="neighbor_average.html">Static and Dynamic Topology Neighbor Averaging</a></li>
<li class="toctree-l1"><a class="reference internal" href="running.html">Lauching Application Through bfrun</a></li>
<li class="toctree-l1"><a class="reference internal" href="docker.html">Bluefog Docker Usage</a></li>
<li class="toctree-l1"><a class="reference internal" href="env_variable.html">Bluefog Environment Variable</a></li>
<li class="toctree-l1"><a class="reference internal" href="timeline.html">Bluefog Timeline</a></li>
<li class="toctree-l1"><a class="reference internal" href="alg_spectrum.html">Spectrum of Machine Learning Algorithm</a></li>
<li class="toctree-l1"><a class="reference internal" href="code_structure.html">Codebase Structure</a></li>
<li class="toctree-l1"><a class="reference internal" href="devel_guide.html">Development Guide</a></li>
<li class="toctree-l1 current"><a class="current reference internal" href="#">FAQ</a><ul>
<li class="toctree-l2"><a class="reference internal" href="#why-does-the-warning-related-to-num-steps-per-communication-pop-up-in-bluefog-optimizer">Why does the warning related to <code class="docutils literal notranslate"><span class="pre">num_steps_per_communication</span></code> pop up in Bluefog optimizer?</a></li>
</ul>
</li>
</ul>

            
          
        </div>
        
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap">

      
      <nav class="wy-nav-top" aria-label="top navigation">
        
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="index.html">Bluefog</a>
        
      </nav>


      <div class="wy-nav-content">
        
        <div class="rst-content">
        
          

















<div role="navigation" aria-label="breadcrumbs navigation">

  <ul class="wy-breadcrumbs">
    
      <li><a href="index.html" class="icon icon-home"></a> &raquo;</li>
        
      <li>FAQ</li>
    
    
      <li class="wy-breadcrumbs-aside">
        
          
            <a href="_sources/faq.rst.txt" rel="nofollow"> View page source</a>
          
        
      </li>
    
  </ul>

  
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
            
  <div class="section" id="faq">
<span id="id1"></span><h1>FAQ<a class="headerlink" href="#faq" title="Permalink to this headline">¶</a></h1>
<div class="contents local topic" id="question-lists">
<p class="topic-title">Question Lists</p>
<ul class="simple">
<li><p><a class="reference internal" href="#why-does-the-warning-related-to-num-steps-per-communication-pop-up-in-bluefog-optimizer" id="id2">Why does the warning related to <code class="docutils literal notranslate"><span class="pre">num_steps_per_communication</span></code> pop up in Bluefog optimizer?</a></p></li>
</ul>
</div>
<div class="section" id="why-does-the-warning-related-to-num-steps-per-communication-pop-up-in-bluefog-optimizer">
<h2><a class="toc-backref" href="#id2">Why does the warning related to <code class="docutils literal notranslate"><span class="pre">num_steps_per_communication</span></code> pop up in Bluefog optimizer?</a><a class="headerlink" href="#why-does-the-warning-related-to-num-steps-per-communication-pop-up-in-bluefog-optimizer" title="Permalink to this headline">¶</a></h2>
<p>During your usage of Bluefog distributed optimizer, you may encounter the following
two types of warnings:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span>Warning (unexpected behavior):
  After num_steps_per_communication times of forward computation `y=model(x)` are called,
  an optimizer step() function must be called.
  It does not matter how many step() functions are called in between.
  Please adjust num_step_per_communication to update model parameters locally.
  More information can be found in the FAQ page.
</pre></div>
</div>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span>Warning (unexpected behavior):
  After num_steps_per_communication times of backward computation `loss.backward()` are called,
  an optimizer step() function must be called.
  It does not matter how many step() functions are called in between.
  Please adjust num_steps_per_communication to accumulate gradients locally.
  More information can be found in the FAQ page.
</pre></div>
</div>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>The second warning is only encountered when using <code class="docutils literal notranslate"><span class="pre">DistributedGradientAllreduceOptimizer</span></code> or
<code class="docutils literal notranslate"><span class="pre">DistributedAdaptThenCombineOptimizer</span></code>. The difference with other Bluefog optimizer is when
counting is triggered. All other Bluefog optimizers triggers this counting
behavior during forward computation, while <code class="docutils literal notranslate"><span class="pre">DistributedGradientAllreduceOptimizer</span></code> and
<code class="docutils literal notranslate"><span class="pre">DistributedAdaptThenCombineOptimizer</span></code> triggers during backward computation.
This is also reflected by the optimizer argument naming.</p>
</div>
<p>To understand the meaning of the above two warnings,
consider the following admissible code snippet for local gradient aggregation case:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">opt</span> <span class="o">=</span> <span class="n">bf</span><span class="o">.</span><span class="n">DistributedAdaptWithCombineOptimizer</span><span class="p">(</span>
  <span class="n">optimizer</span><span class="p">,</span> <span class="n">model</span><span class="o">=</span><span class="n">model</span><span class="p">,</span> <span class="n">communication_type</span><span class="o">=</span><span class="n">bf</span><span class="o">.</span><span class="n">CommunicationType</span><span class="o">.</span><span class="n">neighbor_allreduce</span><span class="p">,</span>
<span class="hll">  <span class="n">num_steps_per_communication</span><span class="o">=</span><span class="n">J</span><span class="p">)</span>
</span><span class="k">for</span> <span class="n">_</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">num_epochs</span><span class="p">):</span>
   <span class="k">for</span> <span class="n">data</span><span class="p">,</span> <span class="n">target</span> <span class="ow">in</span> <span class="n">dataloader</span><span class="p">:</span>
     <span class="n">opt</span><span class="o">.</span><span class="n">zero_grad</span><span class="p">()</span>
     <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">J</span><span class="p">):</span>
       <span class="n">data_mini_batch</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="n">i</span><span class="p">::</span><span class="n">J</span><span class="p">]</span> <span class="c1"># Make sure batch_size = J * mini_batch_size</span>
       <span class="n">target_mini_batch</span> <span class="o">=</span> <span class="n">target</span><span class="p">[</span><span class="n">i</span><span class="p">::</span><span class="n">J</span><span class="p">]</span>
<span class="hll">       <span class="n">y</span> <span class="o">=</span> <span class="n">model</span><span class="p">(</span><span class="n">data_mini_batch</span><span class="p">)</span> <span class="c1"># Forward Computation &lt;- Counting occurs.</span>
</span>       <span class="n">loss</span> <span class="o">=</span> <span class="n">mseloss</span><span class="p">(</span><span class="n">y</span><span class="p">,</span> <span class="n">target_mini_batch</span><span class="p">)</span>
       <span class="n">loss</span><span class="o">.</span><span class="n">backward</span><span class="p">()</span>
<span class="hll">     <span class="n">opt</span><span class="o">.</span><span class="n">step</span><span class="p">()</span> <span class="c1"># Step Function &lt;- Communication occurs and counting is reset.</span>
</span></pre></div>
</div>
<p>We use <strong>F</strong> to denote forward computation <code class="docutils literal notranslate"><span class="pre">y=model(data_mini_batch)</span></code>,
and use <strong>S</strong> to denote step function <code class="docutils literal notranslate"><span class="pre">opt.step()</span></code> with communication occurrence.
For example, let’s say <code class="docutils literal notranslate"><span class="pre">J</span></code> is 3.
For each batch, the calling sequence is <strong>FFFS</strong>, ignoring other operations.
We can see that step function happens right after <code class="docutils literal notranslate"><span class="pre">J=3</span></code> forward computations.
With that, we accumulate the update for the model parameters in all <code class="docutils literal notranslate"><span class="pre">J=3</span></code> mini batches locally,
and reduce the model parameters during the step function in a AWC style.</p>
<p>If <code class="docutils literal notranslate"><span class="pre">num_steps_per_communication</span></code> here doesn’t match the number of mini batchs,
the warning will be triggered.
For example, there are 4 mini batches, with a <code class="docutils literal notranslate"><span class="pre">num_steps_per_communication</span></code> of 3,
then the calling sequence is <strong>FFFFS</strong>. The warning will be thrown at the fourth <strong>F</strong>,
because after 3 <strong>F</strong>, it should expect an <strong>S</strong> following it.</p>
<p>Let’s check another admissible code snippet for multi-round computation per communication case.</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">opt</span> <span class="o">=</span> <span class="n">bf</span><span class="o">.</span><span class="n">DistributedAdaptWithCombineOptimizer</span><span class="p">(</span>
  <span class="n">optimizer</span><span class="p">,</span> <span class="n">model</span><span class="o">=</span><span class="n">model</span><span class="p">,</span> <span class="n">communication_type</span><span class="o">=</span><span class="n">bf</span><span class="o">.</span><span class="n">CommunicationType</span><span class="o">.</span><span class="n">neighbor_allreduce</span><span class="p">,</span>
<span class="hll">  <span class="n">num_steps_per_communication</span><span class="o">=</span><span class="n">J</span><span class="p">)</span>
</span><span class="k">for</span> <span class="n">_</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">num_epochs</span><span class="p">):</span>
   <span class="k">for</span> <span class="n">data</span><span class="p">,</span> <span class="n">target</span> <span class="ow">in</span> <span class="n">dataloader</span><span class="p">:</span>
     <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">J</span><span class="p">):</span>
       <span class="n">data_mini_batch</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="n">i</span><span class="p">::</span><span class="n">J</span><span class="p">]</span> <span class="c1"># Make sure batch_size = J * mini_batch_size</span>
       <span class="n">target_mini_batch</span> <span class="o">=</span> <span class="n">target</span><span class="p">[</span><span class="n">i</span><span class="p">::</span><span class="n">J</span><span class="p">]</span>
<span class="hll">       <span class="n">y</span> <span class="o">=</span> <span class="n">model</span><span class="p">(</span><span class="n">data_mini_batch</span><span class="p">)</span> <span class="c1"># Forward Computation &lt;- Counting occurs.</span>
</span>       <span class="n">loss</span> <span class="o">=</span> <span class="n">mseloss</span><span class="p">(</span><span class="n">y</span><span class="p">,</span> <span class="n">target_mini_batch</span><span class="p">)</span>
       <span class="n">opt</span><span class="o">.</span><span class="n">zero_grad</span><span class="p">()</span>
       <span class="n">loss</span><span class="o">.</span><span class="n">backward</span><span class="p">()</span>
<span class="hll">       <span class="n">opt</span><span class="o">.</span><span class="n">step</span><span class="p">()</span> <span class="c1"># Step Function &lt;- Communication occurs at Jth iteration and counting is reset.</span>
</span></pre></div>
</div>
<p>Similar as before, the calling sequence is <strong>FsFsFS</strong>.
Here <strong>s</strong> stands for the step function without communication (reduce) occurrence.
After <code class="docutils literal notranslate"><span class="pre">J=3</span></code> forward computations happen, a step function called triggers communication.
However, all other step functions in between, denoted by <strong>s</strong>, doesn’t trigger communication.
With that, we update the model locally after each mini batch; and at the last mini batch,
the model parameters are reduced with its neighbors.</p>
<p>In this case, if <code class="docutils literal notranslate"><span class="pre">num_steps_per_communication</span></code> here doesn’t match the number of mini batchs,
the situation may be more dangerous, as no warning will be thrown.
For example, there are 4 mini batches, with a <code class="docutils literal notranslate"><span class="pre">num_steps_per_communication</span></code> of 3,
then the calling sequence is <strong>FsFsFSFs</strong> for the first batch. The communication is completed at
the third mini batch, and there is one mini batch left in the first batch. For the second batch,
the calling sequence is <strong>FsFSFsFs</strong>. We can see that the communication is finished at the second
mini batch here, due to the left over mini batch in the first batch. No warning is thrown during
this process, since after every 3 <strong>F</strong>, an <strong>S</strong> is followed.
This kind of behavior may not be desired, and users should be careful with this situation.</p>
<p>These are two common usages for <code class="docutils literal notranslate"><span class="pre">num_steps_per_communication</span></code>  for
Bluefog distributed optimizer. But other usage is also allowed, as long as after
<code class="docutils literal notranslate"><span class="pre">num_steps_per_communication</span></code> forward computation or  backward propogation, the step function is executed.
With that in mind, some other admissible calling procedures are <strong>FFsFS</strong>, <strong>FsFFS</strong>, etc.
Some inadmissible calling procedures are <strong>FFFFS</strong>, <strong>FFsFFS</strong>.</p>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>The previous discussion only applies to computation in the PyTorch computation graph.
The code inside <code class="docutils literal notranslate"><span class="pre">with</span> <span class="pre">torch.no_grad()</span></code> or PyTorch tensors with <code class="docutils literal notranslate"><span class="pre">requires_grad=False</span></code>
are not counted.</p>
</div>
</div>
</div>


           </div>
           
          </div>
          <footer>
    <div class="rst-footer-buttons" role="navigation" aria-label="footer navigation">
        <a href="devel_guide.html" class="btn btn-neutral float-left" title="BlueFog Development Guide" accesskey="p" rel="prev"><span class="fa fa-arrow-circle-left" aria-hidden="true"></span> Previous</a>
    </div>

  <hr/>

  <div role="contentinfo">
    <p>
        &#169; Copyright 2020, BlueFog Team.

    </p>
  </div>
    
    
    
    Built with <a href="https://www.sphinx-doc.org/">Sphinx</a> using a
    
    <a href="https://github.com/readthedocs/sphinx_rtd_theme">theme</a>
    
    provided by <a href="https://readthedocs.org">Read the Docs</a>. 

</footer>
        </div>
      </div>

    </section>

  </div>
  

  <script type="text/javascript">
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script>

  
  
    
   

</body>
</html>