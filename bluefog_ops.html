

<!DOCTYPE html>
<html class="writer-html5" lang="en" >
<head>
  <meta charset="utf-8" />
  
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  
  <title>Bluefog Operations Explanation &mdash; Bluefog  documentation</title>
  

  
  <link rel="stylesheet" href="_static/css/theme.css" type="text/css" />
  <link rel="stylesheet" href="_static/pygments.css" type="text/css" />
  <link rel="stylesheet" href="_static/plot_directive.css" type="text/css" />

  
  
    <link rel="shortcut icon" href="_static/favicon.png"/>
  

  
  

  

  
  <!--[if lt IE 9]>
    <script src="_static/js/html5shiv.min.js"></script>
  <![endif]-->
  
    
      <script type="text/javascript" id="documentation_options" data-url_root="./" src="_static/documentation_options.js"></script>
        <script src="_static/jquery.js"></script>
        <script src="_static/underscore.js"></script>
        <script src="_static/doctools.js"></script>
    
    <script type="text/javascript" src="_static/js/theme.js"></script>

    
    <link rel="index" title="Index" href="genindex.html" />
    <link rel="search" title="Search" href="search.html" />
    <link rel="next" title="Performance" href="performance.html" />
    <link rel="prev" title="Topology Related Utility Functions" href="topo_api.html" /> 
</head>

<body class="wy-body-for-nav">

   
  <div class="wy-grid-for-nav">
    
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >
          

          
            <a href="index.html" class="icon icon-home"> Bluefog
          

          
          </a>

          
            
            
              <div class="version">
                0.2.2
              </div>
            
          

          
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>

          
        </div>

        
        <div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="main navigation">
          
            
            
              
            
            
              <p class="caption"><span class="caption-text">INSTALLATION</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="install.html">Installing Bluefog</a></li>
</ul>
<p class="caption"><span class="caption-text">API</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="torch_api.html">Bluefog Torch API</a></li>
<li class="toctree-l1"><a class="reference internal" href="topo_api.html">Bluefog Topology API</a></li>
</ul>
<p class="caption"><span class="caption-text">More Information</span></p>
<ul class="current">
<li class="toctree-l1 current"><a class="current reference internal" href="#">Bluefog Ops Explanation</a><ul>
<li class="toctree-l2"><a class="reference internal" href="#collective-ops">Collective Ops</a><ul>
<li class="toctree-l3"><a class="reference internal" href="#allgather">allgather</a></li>
<li class="toctree-l3"><a class="reference internal" href="#allreduce">allreduce</a></li>
<li class="toctree-l3"><a class="reference internal" href="#broadcast">broadcast</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="#neighbor-colletive-ops">Neighbor Colletive Ops</a><ul>
<li class="toctree-l3"><a class="reference internal" href="#neighbor-allgather">neighbor_allgather</a></li>
<li class="toctree-l3"><a class="reference internal" href="#neighbor-allreduce">neighbor_allreduce</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="#hierarchical-collective-ops">Hierarchical Collective Ops</a><ul>
<li class="toctree-l3"><a class="reference internal" href="#hierarchical-local-allreduce">hierarchical_local_allreduce</a></li>
<li class="toctree-l3"><a class="reference internal" href="#hierarchical-neighbor-allreduce">hierarchical_neighbor_allreduce</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="#one-sided-communication-ops">One-sided Communication Ops</a><ul>
<li class="toctree-l3"><a class="reference internal" href="#win-create">win_create</a></li>
<li class="toctree-l3"><a class="reference internal" href="#win-free">win_free</a></li>
<li class="toctree-l3"><a class="reference internal" href="#win-put">win_put</a></li>
<li class="toctree-l3"><a class="reference internal" href="#win-get">win_get</a></li>
<li class="toctree-l3"><a class="reference internal" href="#win-accumulate">win_accumulate</a></li>
<li class="toctree-l3"><a class="reference internal" href="#win-update">win_update</a></li>
<li class="toctree-l3"><a class="reference internal" href="#win-update-then-collect">win_update_then_collect</a></li>
</ul>
</li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="performance.html">Bluefog Performance</a></li>
<li class="toctree-l1"><a class="reference internal" href="neighbor_average.html">Static and Dynamic Topology Neighbor Averaging</a></li>
<li class="toctree-l1"><a class="reference internal" href="running.html">Lauching Application Through bfrun</a></li>
<li class="toctree-l1"><a class="reference internal" href="docker.html">Bluefog Docker Usage</a></li>
<li class="toctree-l1"><a class="reference internal" href="env_variable.html">Bluefog Environment Variable</a></li>
<li class="toctree-l1"><a class="reference internal" href="timeline.html">Bluefog Timeline</a></li>
<li class="toctree-l1"><a class="reference internal" href="alg_spectrum.html">Spectrum of Machine Learning Algorithm</a></li>
<li class="toctree-l1"><a class="reference internal" href="code_structure.html">Codebase Structure</a></li>
<li class="toctree-l1"><a class="reference internal" href="devel_guide.html">Development Guide</a></li>
<li class="toctree-l1"><a class="reference internal" href="faq.html">FAQ</a></li>
</ul>

            
          
        </div>
        
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap">

      
      <nav class="wy-nav-top" aria-label="top navigation">
        
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="index.html">Bluefog</a>
        
      </nav>


      <div class="wy-nav-content">
        
        <div class="rst-content">
        
          

















<div role="navigation" aria-label="breadcrumbs navigation">

  <ul class="wy-breadcrumbs">
    
      <li><a href="index.html" class="icon icon-home"></a> &raquo;</li>
        
      <li>Bluefog Operations Explanation</li>
    
    
      <li class="wy-breadcrumbs-aside">
        
          
            <a href="_sources/bluefog_ops.rst.txt" rel="nofollow"> View page source</a>
          
        
      </li>
    
  </ul>

  
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
            
  <div class="section" id="bluefog-operations-explanation">
<span id="ops-explanation"></span><h1>Bluefog Operations Explanation<a class="headerlink" href="#bluefog-operations-explanation" title="Permalink to this headline">¶</a></h1>
<p>The implementation of bluefog operations is built upon the MPI APIs.
The naming of communication operations are all derived from MPI. However,
our usage and definition are slightly different from the MPI since the focus of bluefog ops
are highly associated with the virtual topology of network.</p>
<p>The communication ops that bluefog supported can be catogorized into three types:</p>
<ol class="arabic simple">
<li><p>Collective Ops: <code class="docutils literal notranslate"><span class="pre">broadcast</span></code>, <code class="docutils literal notranslate"><span class="pre">allreduce</span></code>, <code class="docutils literal notranslate"><span class="pre">allgather</span></code>.</p></li>
<li><p>Neighbor Collective Ops: <code class="docutils literal notranslate"><span class="pre">neighbor_allreduce</span></code>, <code class="docutils literal notranslate"><span class="pre">neighbor_allgather</span></code>.</p></li>
<li><p>Hierarchical Collective Ops:  <code class="docutils literal notranslate"><span class="pre">hierarchical_local_allreduce</span></code>, <code class="docutils literal notranslate"><span class="pre">hierarchical_neighbor_allreduce</span></code>.</p></li>
<li><p>One-sided Communication Ops: <code class="docutils literal notranslate"><span class="pre">win_create</span></code>, <code class="docutils literal notranslate"><span class="pre">win_free</span></code>, <code class="docutils literal notranslate"><span class="pre">win_put</span></code>, <code class="docutils literal notranslate"><span class="pre">win_get</span></code>, <code class="docutils literal notranslate"><span class="pre">win_accumulate</span></code>, <code class="docutils literal notranslate"><span class="pre">win_update</span></code>, <code class="docutils literal notranslate"><span class="pre">win_update_then_collect</span></code>.</p></li>
</ol>
<p>We use figure to illustrate all those ops with
similar style as in <a class="reference external" href="https://mpitutorial.com/tutorials/">MPI tutorials blog</a>.
In the figure, we use <em>circle</em> to represent one process, which is exchangeablely called node,
agent, host, etc. under some circumstance, and use green and red <em>square</em> to represent the data or tensor while
orange <em>square</em> for one machine.
The number inside of circle is the rank of that process and th number inside of square is the value of data.
If you need more background information about MPI, we recommend this nice <a class="reference external" href="https://computing.llnl.gov/tutorials/mpi/">tutorial</a>.</p>
<div class="section" id="collective-ops">
<h2>Collective Ops<a class="headerlink" href="#collective-ops" title="Permalink to this headline">¶</a></h2>
<p>These three <code class="docutils literal notranslate"><span class="pre">broadcast</span></code>, <code class="docutils literal notranslate"><span class="pre">allreduce</span></code>, <code class="docutils literal notranslate"><span class="pre">allgather</span></code> ops are most basic collective MPI ops.
The bluefog implementation is almost exactly the same as the MPI definition. One small difference
is allreduce only support average and summation since bluefog focused on the numerical calculation only.</p>
<div class="section" id="allgather">
<h3>allgather<a class="headerlink" href="#allgather" title="Permalink to this headline">¶</a></h3>
<a class="reference internal image-reference" href="_images/bf_allgather.png"><img alt="BluefogAllgatherExplanation" src="_images/bf_allgather.png" style="width: 350px;" /></a>
</div>
<div class="section" id="allreduce">
<h3>allreduce<a class="headerlink" href="#allreduce" title="Permalink to this headline">¶</a></h3>
<a class="reference internal image-reference" href="_images/bf_allreduce.png"><img alt="BluefogAllreduceExplanation" src="_images/bf_allreduce.png" style="width: 300px;" /></a>
</div>
<div class="section" id="broadcast">
<h3>broadcast<a class="headerlink" href="#broadcast" title="Permalink to this headline">¶</a></h3>
<a class="reference internal image-reference" href="_images/bf_broadcast.png"><img alt="BluefogBroadcastExplanation" src="_images/bf_broadcast.png" style="width: 450px;" /></a>
</div>
</div>
<div class="section" id="neighbor-colletive-ops">
<h2>Neighbor Colletive Ops<a class="headerlink" href="#neighbor-colletive-ops" title="Permalink to this headline">¶</a></h2>
<p>Similar to their collective ops cousins, the behavior of neighbor collective ops is very similar,
except that their behavior is determined by the virtual topology as well. Loosenly speaking,
allreduce and allgather are the same as running the neighbor_allreduce and neighbor_allgather
over fully connected network. In the figure, we use the arrowed line to represent the connection of
virtual topology (notice it is the directed graph.)</p>
<div class="section" id="neighbor-allgather">
<h3>neighbor_allgather<a class="headerlink" href="#neighbor-allgather" title="Permalink to this headline">¶</a></h3>
<a class="reference internal image-reference" href="_images/bf_neighbor_allgather.png"><img alt="BluefogNeighborAllgatherExplanation" src="_images/bf_neighbor_allgather.png" style="width: 600px;" /></a>
</div>
<div class="section" id="neighbor-allreduce">
<h3>neighbor_allreduce<a class="headerlink" href="#neighbor-allreduce" title="Permalink to this headline">¶</a></h3>
<a class="reference internal image-reference" href="_images/bf_neighbor_allreduce.png"><img alt="BluefogNeighborAllreduceExplanation" src="_images/bf_neighbor_allreduce.png" style="width: 600px;" /></a>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>In the figure, we only show the neighbor_allreduce with average with uniform weight. Actually, our
API allows for any weights for incoming edges. Check out API doc to see how to use it.</p>
</div>
</div>
</div>
<div class="section" id="hierarchical-collective-ops">
<h2>Hierarchical Collective Ops<a class="headerlink" href="#hierarchical-collective-ops" title="Permalink to this headline">¶</a></h2>
<p>In practice, the communication speed and behavior is different between intra-machine and inter-machine communcation.
Hence, we also provided two hierarchical collective ops. The basic unit in this case is each (physical) machine.
Hence, unlike previous neighbor collective ops, of which the topology is defined over the connection between ranks/processes,
the topology of hierarchical collective ops is defined over the connection between machines.</p>
<div class="section" id="hierarchical-local-allreduce">
<h3>hierarchical_local_allreduce<a class="headerlink" href="#hierarchical-local-allreduce" title="Permalink to this headline">¶</a></h3>
<a class="reference internal image-reference" href="_images/bf_hier_local_allreduce.png"><img alt="BluefogHierarchicalLocalAllreduceExplanation" src="_images/bf_hier_local_allreduce.png" style="width: 700px;" /></a>
<p>Because it is (machine) local operation, the topology definition will not impact this operation. Hence, the rank 0 and rank 1
simply applied the local allreduce average to get (8+4)/2 = 6. Other ranks is like-wise.</p>
</div>
<div class="section" id="hierarchical-neighbor-allreduce">
<h3>hierarchical_neighbor_allreduce<a class="headerlink" href="#hierarchical-neighbor-allreduce" title="Permalink to this headline">¶</a></h3>
<a class="reference internal image-reference" href="_images/bf_hier_neighbor_allreduce.png"><img alt="BluefogHierarchicalNeighborAllreduceExplanation" src="_images/bf_hier_neighbor_allreduce.png" style="width: 700px;" /></a>
<p>Similar to the <em>hierarchical_local_allreduce</em> operation, it first applied the local allreduce average within the machine.
So that in the view of external machines, all processes within same machine forms a super node. Then, the super node exchange the
information with their neighbor machines like <em>neighbor_allreduce</em>. For example, machine 0, 2, and 3 first formed a local average value
6, 3, and 3 respectively. Then, a machine-wise neighbor allreduce produce (6+3+3)/3 = 4.</p>
<p>In order to minimize the cross machines communcation, the real implementation is four steps actually: 1. Local Average. 2. All local rank
0 processes do the <em>neihbor_allreduce</em>. 3. local rank 0 processes broadcast the received tensors to other local ranks. 4. Compute the average of
received neighbor tensors within the process.</p>
<div class="admonition warning">
<p class="admonition-title">Warning</p>
<p>hierarchical_neighbor_allreduce should be used under the homogeneous environment only, i.e., each machine owns same number of
the local processes.</p>
</div>
</div>
</div>
<div class="section" id="one-sided-communication-ops">
<h2>One-sided Communication Ops<a class="headerlink" href="#one-sided-communication-ops" title="Permalink to this headline">¶</a></h2>
<p>One-sided communication ops is introduced after MPI-2. The most notable feature of
one-sided communication is indicated by the name that allows the communication ops of
one process to be decoupled from the behavior of another process. Bluefog heavily relies
on this feature to build the asynchronous algorithm. Except the win_create and win_free are
the collective ops, all rest ops only need to be called by one process. <a class="reference external" href="https://pages.tacc.utexas.edu/~eijkhout/pcse/html/mpi-onesided.html">Here</a> is a nice introduction
for the MPI one-sided communication ops. As mentioned before, please note the usage and definition of Bluefog
is slightly different from MPI standard.</p>
<div class="section" id="win-create">
<h3>win_create<a class="headerlink" href="#win-create" title="Permalink to this headline">¶</a></h3>
<p>Win create is always the first step to use the one-sided communication. After this call,
each process will allocate the number of incoming neighbor’s windows as buffer, which is illustrated
in the figure as red square. Each buffer is dedicated to one neighbor. You don’t need to know
which one is dedicated to which neighbor because these buffers are invisible to the python frontend.
The only way to interact with them is through the win_update.</p>
<a class="reference internal image-reference" href="_images/bf_win_create.png"><img alt="BluefogWinCreateExplanation" src="_images/bf_win_create.png" style="width: 650px;" /></a>
</div>
<div class="section" id="win-free">
<h3>win_free<a class="headerlink" href="#win-free" title="Permalink to this headline">¶</a></h3>
<a class="reference internal image-reference" href="_images/bf_win_free.png"><img alt="BluefogWinFreeExplanation" src="_images/bf_win_free.png" style="width: 650px;" /></a>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>In the following figures, we only show the behavior of win_put/get/accumulate/sync to all neighbors
with no weights. Actually, you are allowed to customize which neighbor to send/receive and
assign any weight on tensor. Please check our API doc to see how to use it.</p>
</div>
</div>
<div class="section" id="win-put">
<h3>win_put<a class="headerlink" href="#win-put" title="Permalink to this headline">¶</a></h3>
<p>Win_put is one of three main methods to exchange the information between the processes in window.
By default, it will <em>put</em> its own tensor value into all <em>outgoing</em> neighbor’s buffer.
Note it doesn’t need the receiver to do anything.</p>
<a class="reference internal image-reference" href="_images/bf_win_put.png"><img alt="BluefogWinPutExplanation" src="_images/bf_win_put.png" style="width: 650px;" /></a>
</div>
<div class="section" id="win-get">
<h3>win_get<a class="headerlink" href="#win-get" title="Permalink to this headline">¶</a></h3>
<p>Win_get is one of three main methods to exchange the information between the processes in window.
By default, it will <em>get</em> (fetch) the <em>incoming</em> neighbor’s local value into the its own buffer.
Note it doesn’t need the sender to do anything.</p>
<a class="reference internal image-reference" href="_images/bf_win_get.png"><img alt="BluefogWinGetExplanation" src="_images/bf_win_get.png" style="width: 650px;" /></a>
</div>
<div class="section" id="win-accumulate">
<h3>win_accumulate<a class="headerlink" href="#win-accumulate" title="Permalink to this headline">¶</a></h3>
<p>Win_accumulate is one of three main methods to exchange the information between the processes in window.
By default, it will <em>accumulate</em> its own tensor value into all <em>outgoing</em> neighbor’s buffer, i.e. sum up.
Note it doesn’t need the receiver to do anything.</p>
<a class="reference internal image-reference" href="_images/bf_win_accum.png"><img alt="BluefogWinAccumExplanation" src="_images/bf_win_accum.png" style="width: 650px;" /></a>
</div>
<div class="section" id="win-update">
<h3>win_update<a class="headerlink" href="#win-update" title="Permalink to this headline">¶</a></h3>
<p>win_update is the bridge to connect the value of buffers (corresponding to the neighbor value)
with the local value. It has two functionalities. One is to update the buffer to make sure that the
neighbor value, which may be changed through win_put, win_get, and/or win_accumulate, is synchronized
and visible to local memory. Another is it updates the local value to the average of self and neighbor’s value.</p>
<a class="reference internal image-reference" href="_images/bf_win_update.png"><img alt="BluefogWinSyncExplanation" src="_images/bf_win_update.png" style="width: 650px;" /></a>
</div>
<div class="section" id="win-update-then-collect">
<h3>win_update_then_collect<a class="headerlink" href="#win-update-then-collect" title="Permalink to this headline">¶</a></h3>
<a class="reference internal image-reference" href="_images/bf_win_update_collect.png"><img alt="BluefogWinSyncThenCollectExplanation" src="_images/bf_win_update_collect.png" style="width: 675px;" /></a>
</div>
</div>
</div>


           </div>
           
          </div>
          <footer>
    <div class="rst-footer-buttons" role="navigation" aria-label="footer navigation">
        <a href="performance.html" class="btn btn-neutral float-right" title="Performance" accesskey="n" rel="next">Next <span class="fa fa-arrow-circle-right" aria-hidden="true"></span></a>
        <a href="topo_api.html" class="btn btn-neutral float-left" title="Topology Related Utility Functions" accesskey="p" rel="prev"><span class="fa fa-arrow-circle-left" aria-hidden="true"></span> Previous</a>
    </div>

  <hr/>

  <div role="contentinfo">
    <p>
        &#169; Copyright 2020, BlueFog Team.

    </p>
  </div>
    
    
    
    Built with <a href="https://www.sphinx-doc.org/">Sphinx</a> using a
    
    <a href="https://github.com/readthedocs/sphinx_rtd_theme">theme</a>
    
    provided by <a href="https://readthedocs.org">Read the Docs</a>. 

</footer>
        </div>
      </div>

    </section>

  </div>
  

  <script type="text/javascript">
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script>

  
  
    
   

</body>
</html>